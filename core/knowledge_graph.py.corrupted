from .knowledge_graph import KnowledgeGraph

def build_knowledge_graph_from_analysis(analysis_result: dict) -> KnowledgeGraph:
    """
    Construye un grafo de conocimiento usando SOLO:
    - containers_detected (C2)
    - components_detected (C3)
    - relations_detected (dependencias entre componentes)
    """

    kg = KnowledgeGraph()

    # =======================================================
    # 1) AGREGAR CONTENEDORES COMO NODOS PRINCIPALES (C2)
    # =======================================================
    for container in analysis_result.get("containers_detected", []):
        node_id = container["path"]

        kg.graph.add_node(
            node_id,
            node_type="container",
            name=container.get("type", "Container"),
            technology=container.get("technology", ""),
            path=container.get("path"),
            confidence=container.get("confidence", ""),
            score=container.get("score", 0)
        )

    # =======================================================
    # 2) AGREGAR COMPONENTES (C3)
    # =======================================================
    for comp in analysis_result.get("components_detected", []):
        node_id = comp["path"]

        kg.graph.add_node(
            node_id,
            node_type="component",
            name=comp["name"],
            comp_type=comp["type"],
            classes=comp.get("classes", []),
            entry_points=comp.get("entry_points", []),
            path=comp["path"]
        )

        # Asignar componente a contenedor C2 si est√° dentro de su folder
        for container in analysis_result.get("containers_detected", []):
            cont_path = container["path"]
            if node_id.startswith(cont_path):
                kg.graph.add_edge(cont_path, node_id, relation="contains")

    # =======================================================
    # 3) AGREGAR RELACIONES ENTRE COMPONENTES
    # =======================================================
    for rel in analysis_result.get("relations_detected", []):
        src = rel["from"]
        dst = rel["to"]

        # Hay que convertir nombres de archivo a paths reales
        src_node = None
        dst_node = None

        # buscar archivo en componentes
        for comp in analysis_result.get("components_detected", []):
            if comp["name"] == src:
                src_node = comp["path"]
            if comp["name"] == dst or dst in comp["path"]:
                dst_node = comp["path"]

        # Si ambos existen, agregar
        if src_node and dst_node:
            kg.graph.add_edge(src_node, dst_node, relation="imports")

    return kg
